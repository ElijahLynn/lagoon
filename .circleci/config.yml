version: 2
jobs:
  build:
    machine:
      enabled: true
      image: circleci/classic:edge

    steps:
      - checkout

      - run:
          name: login to dockerhub
          command: docker login -u amazeeiojenkins -p $DOCKERHUB_PASSWORD

      - run:
          name: load cache docker images from dockerhub
          command: make images-cache-pull IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH

      - run:
          name: show existing images
          command: docker image ls -a --digests

      - run:
          name: check docker
          command: |
            sudo sh -c "echo \"DOCKER_OPTS='--insecure-registry 172.30.0.0/16'\" >> /etc/default/docker"
            sudo service docker restart
            sudo mount --make-rshared /

      - run:
          name: Start openshift
          command: |
            sudo ./startOpenShift.sh

      - run:
          name: Build Images
          command: |
            set -x
            make build-single services-build-single IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH

      - run:
          name: docker-compose up
          command: |
            IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH docker-compose up -d

      - run:
          name: docker-compose logs
          command: |
            IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH docker-compose logs -f
          background: true

      - run:
          name: sleep 30 to allow services to boot
          command: sleep 30

      - run:
          name: run tests
          command: |
            IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH docker-compose run --rm tests ansible-playbook /ansible/tests/ALL.yaml

      - run:
          name: push cache docker images to dockerhub
          command: make images-cache-push IMAGEREPO=amazeeiodev IMAGESUFFIX=$CIRCLE_BRANCH
